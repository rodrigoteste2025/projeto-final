<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cadastro IDAF</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- EXCEL / PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  /* Base */
  --bg:#f3f4f6;
  --surface:#ffffff;
  --surface-2:#f9fafb;
  --text:#0f172a;
  --muted:#64748b;
  --border:#d1d5db;
  --border2:#e5e7eb;

  /* Brand */
  --primary:#1f6fb2;
  --primary-dark:#185a8d;

  /* Status */
  --danger:#b91c1c;
  --danger-soft:#ffe6e6;

  --warning:#b45309;
  --warning-soft:#fff3cd;

  --ok:#166534;
  --ok-soft:#e8f7ee;

  /* Effects */
  --shadow-sm: 0 4px 14px rgba(2, 6, 23, .08);
  --shadow: 0 10px 26px rgba(2, 6, 23, .10);
  --radius: 14px;
  --radius-sm: 12px;

  --ring: 0 0 0 4px rgba(31,111,178,.14);

  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b1220;
    --surface:#0f172a;
    --surface-2:#111c33;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --border:#24324d;
    --border2:#1f2a44;

    --shadow-sm: 0 6px 18px rgba(0,0,0,.40);
    --shadow: 0 14px 34px rgba(0,0,0,.50);
    --ring: 0 0 0 4px rgba(56,189,248,.18);

    --danger-soft: rgba(185,28,28,.18);
    --warning-soft: rgba(180,83,9,.18);
    --ok-soft: rgba(22,101,52,.20);
  }
}

*{ box-sizing:border-box; }
html{ -webkit-text-size-adjust:100%; }
body{
  margin:0;
  padding:16px;
  font-family: var(--font);
  background: radial-gradient(1200px 600px at 20% -10%, rgba(31,111,178,.10), transparent 60%),
              radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.08), transparent 55%),
              var(--bg);
  color: var(--text);
  line-height: 1.35;
}

/* container */
.container{
  max-width: 1200px;
  margin: 0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* topbar */
.topbar{
  background: color-mix(in srgb, var(--surface) 92%, transparent);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 10px;
  z-index: 10;
  backdrop-filter: blur(8px);
}

.topbar-row{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.title h2{
  margin:0;
  font-size: 18px;
  letter-spacing: .2px;
}
.title p{
  margin:6px 0 0;
  font-size: 13px;
  color: var(--muted);
}

/* controls */
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.search{
  flex: 1;
  min-width: 240px;
  position: relative;
}
.search .icon{
  position:absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  opacity:.65;
  font-size: 14px;
}

/* ‚úÖ IMPORTANTE: checkbox/radio N√ÉO entram nessa regra */
input:not([type="checkbox"]):not([type="radio"]),
textarea,
select{
  width: 100%;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  font-size: 14px;
  outline:none;
  background: var(--surface);
  color: var(--text);
  transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
}

.search input{
  padding: 10px 12px 10px 36px;
}

input::placeholder, textarea::placeholder{
  color: color-mix(in srgb, var(--muted) 80%, transparent);
}

input:focus, textarea:focus, select:focus{
  border-color: rgba(31,111,178,.55);
  box-shadow: var(--ring);
}

input:focus-visible, textarea:focus-visible, select:focus-visible,
button:focus-visible{
  outline: none;
  box-shadow: var(--ring);
}

/* remove setas do number (opcional) */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
input[type="number"]{ -moz-appearance: textfield; }

/* ‚úÖ checkbox/radio bonitos e vis√≠veis */
input[type="checkbox"],
input[type="radio"]{
  width: auto;
  height: auto;
  padding: 0;
  accent-color: var(--primary);
  cursor: pointer;
}

/* buttons */
button, .btn{
  width: auto;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  font-size: 14px;
  cursor:pointer;
  transition: transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
  user-select: none;
}

button:hover, .btn:hover{
  background: color-mix(in srgb, var(--surface-2) 60%, var(--surface) 40%);
  box-shadow: 0 6px 16px rgba(2,6,23,.10);
}
button:active, .btn:active{ transform: translateY(1px); }

button:disabled, .btn:disabled{
  opacity:.55;
  cursor:not-allowed;
  box-shadow:none;
  transform:none;
}

.btn-primary{
  background: var(--primary);
  border-color: color-mix(in srgb, var(--primary) 70%, #000 30%);
  color: #fff;
  font-weight: 700;
}
.btn-primary:hover{
  background: var(--primary-dark);
  border-color: var(--primary-dark);
}

.btn-neutral{
  background: #374151;
  border-color: #374151;
  color:#fff;
  font-weight: 700;
}
.btn-neutral:hover{
  background: #1f2937;
  border-color: #1f2937;
}

.btn-outline{
  background: var(--surface);
}

/* notices */
.notice, .aviso-fixo{
  background: var(--warning-soft);
  border: 1px solid color-mix(in srgb, var(--warning) 22%, var(--border2));
  color: var(--warning);
  padding: 12px 14px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

/* card */
.card{
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* form */
form{
  padding:14px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}

textarea{
  grid-column: span 3;
  resize: vertical;
  min-height: 44px;
}

form .full{ grid-column: span 3; }

/* ‚úÖ linha do checkbox no form */
.check-row{
  grid-column: span 3;
  display:flex;
  align-items:center;
  gap:10px;
  padding: 10px 12px;
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  background: color-mix(in srgb, var(--surface) 75%, var(--surface-2));
}
.check-row label{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  font-size: 14px;
  font-weight: 700;
}
.check-row small{
  color: var(--muted);
  font-weight: 500;
}

/* table */
.table-wrap{ overflow-x:auto; }

table{
  width:100%;
  border-collapse: separate;
  border-spacing: 0;
}

thead th{
  background: linear-gradient(180deg, #0f2f4a, #0b243a);
  color: #fff;
  padding: 10px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: .05em;
  border-bottom: 1px solid rgba(255,255,255,.12);
  white-space: nowrap;
}

tbody td{
  padding: 10px;
  border-bottom: 1px solid var(--border2);
  font-size: 13px;
  vertical-align: top;
  overflow-wrap:anywhere;
}

tbody tr:nth-child(even){ background: color-mix(in srgb, var(--surface) 92%, var(--surface-2)); }
tbody tr:hover{ background: color-mix(in srgb, rgba(31,111,178,.10) 60%, var(--surface)); }

/* prazo destaque por linha */
.prazo-alerta{ background: rgba(245,158,11,.10) !important; }
.prazo-encerrado{ background: rgba(220,38,38,.08) !important; }

/* chips */
.chip{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 5px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 12px;
  border: 1px solid var(--border);
  background: var(--surface-2);
  white-space: nowrap;
}

.chip-ok{ background: var(--ok-soft); border-color: rgba(22,101,52,.28); color: var(--ok); }
.chip-warn{ background: var(--warning-soft); border-color: rgba(180,83,9,.28); color: var(--warning); }
.chip-bad{ background: var(--danger-soft); border-color: rgba(185,28,28,.28); color: var(--danger); }

/* actions */
.actions-col{
  display:flex;
  flex-direction: column;
  gap:6px;
  min-width: 120px;
}

.action-btn{
  width:100%;
  padding: 8px 10px;
  border-radius: 10px;
  border:1px solid var(--border);
  font-size: 13px;
  font-weight: 800;
}

.editar{
  background: rgba(31,111,178,.12);
  border-color: rgba(31,111,178,.25);
  color: color-mix(in srgb, var(--primary) 92%, #000 8%);
}
.editar:hover{ background: rgba(31,111,178,.18); }

.excluir{
  background: rgba(185,28,28,.10);
  border-color: rgba(185,28,28,.25);
  color: var(--danger);
}
.excluir:hover{ background: rgba(185,28,28,.16); }

/* ‚úÖ checkbox na tabela alinhado */
td input[type="checkbox"]{
  vertical-align: middle;
}

/* pagination */
.pager{
  padding: 12px 14px;
  border-top: 1px solid var(--border2);
  background: color-mix(in srgb, var(--surface) 82%, var(--surface-2));
  display:flex;
  justify-content: space-between;
  gap:10px;
  flex-wrap: wrap;
  align-items:center;
}

.pager .left, .pager .right{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.pager .info{
  font-size: 13px;
  color: var(--muted);
}

.pager .mini{
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
}
.pager .mini:disabled{
  opacity:.55;
  cursor:not-allowed;
}

/* login */
#loginModal{
  position:fixed;
  inset:0;
  background: rgba(0, 0, 0, 0.55);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 20px;
  z-index: 50;
}

#loginBox{
  width: 340px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}
#loginBox h3{
  margin: 0 0 8px;
  font-size: 16px;
}
#loginBox .hint{
  margin: 0 0 12px;
  color: var(--muted);
  font-size: 13px;
}
#loginBox input{
  width:100%;
  margin-bottom: 10px;
}
#loginBox button{
  width:100%;
}

/* footer */
footer{
  text-align:center;
  color: var(--muted);
  font-size: 12px;
  margin-top: 10px;
}

/* responsive */
@media (max-width: 900px){
  form{ grid-template-columns: 1fr 1fr; }
  textarea, form .full, .check-row{ grid-column: span 2; }
}

@media (max-width: 650px){
  body{ padding:12px; }
  .controls{ flex-direction: column; align-items: stretch; }
  .search{ min-width: 100%; }
  button, select{ width:100%; }
  form{ grid-template-columns: 1fr; }
  textarea, form .full, .check-row{ grid-column: span 1; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; scroll-behavior: auto !important; }
}
/* ====== APENAS DEIXAR MAIS CLARO (SEM MEXER NA LARGURA) ====== */

/* For√ßa tema claro (mesmo se o PC estiver em modo escuro) */
:root{
  --bg:#ffffff;
  --surface:#ffffff;
  --surface-2:#f8fafc;
  --text:#111827;
  --muted:#6b7280;
  --border:#d1d5db;
  --border2:#e5e7eb;

  --shadow-sm: 0 4px 14px rgba(0,0,0,.06);
  --shadow: 0 10px 26px rgba(0,0,0,.08);
}

/* Se existir dark-mode no CSS, neutraliza aqui */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#ffffff;
    --surface:#ffffff;
    --surface-2:#f8fafc;
    --text:#111827;
    --muted:#6b7280;
    --border:#d1d5db;
    --border2:#e5e7eb;
  }
}

/* Fundo branco (remove gradiente/escuro) */
body{
  background: #ffffff !important;
}

/* ‚úÖ DESFAZ ‚Äúalargamentos‚Äù que cortam a tela */
.container{ max-width: 1200px !important; }     /* volta ao normal */
table{ min-width: unset !important; }          /* remove min-width */
th, td{ min-width: unset !important; }         /* remove min-width por coluna */
.table-wrap{ overflow-x: auto; }               /* se precisar, rola s√≥ a tabela */

/* Mant√©m texto leg√≠vel e n√£o cortado */
tbody td{
  white-space: normal;
  overflow-wrap: anywhere;
}





</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginModal">
  <div id="loginBox">
    <h3>Login</h3>
    <p class="hint">Acesso restrito</p>
    <input id="loginUser" placeholder="USU√ÅRIO" oninput="this.value=this.value.toUpperCase()">
    <input id="loginPass" type="password" placeholder="SENHA">
    <button class="btn btn-primary" onclick="login()">Entrar</button>
  </div>
</div>

<div class="container">
  <div class="topbar">
    <div class="topbar-row">
      <div class="title">
        <h2>Acompanhar os Cadastros de Explora√ß√µes Agropecu√°rias</h2>
        <p>
          <span id="contador">0</span> registro(s) ‚Ä¢
          <span id="contadorFiltrado">0</span> ap√≥s filtro ‚Ä¢
          <span id="contadorExibido">0</span nesta p√°gina
        </p>
      </div>

      <div class="controls">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="pesquisa" placeholder="Pesquisar por produtor, col√¥nia, endere√ßo, telefone, apelido, observa√ß√µes..." />
        </div>

        <select id="filtroStatus" title="Filtro por status">
          <option value="TODOS">Status: Todos</option>
          <option value="EM_DIA">Status: Em dia</option>
          <option value="ALERTA">Status: Alerta (‚â§10 dias)</option>
          <option value="ENCERRADO">Status: Encerrado</option>
        </select>

        <button class="btn btn-outline" onclick="limparFiltros()">Limpar</button>
        <button class="btn btn-neutral" onclick="baixarExcel()">üìä Excel</button>
        <button class="btn btn-neutral" onclick="baixarPDF()">üìÑ PDF</button>
      </div>
    </div>
  </div>

  <div class="notice">‚ö†Ô∏è Aviso: o prazo inicial √© de 30 dias, com possibilidade de prorroga√ß√£o por mais 30 dias!</div>
  <div class="notice">‚ö†Ô∏è Aviso: depois da abertura do cadastro no SISDAF, clicar em excluir!</div>

  <div class="card">
    <form id="form">
      <input id="nome" placeholder="PROPRIET√ÅRIO" required oninput="this.value=this.value.toUpperCase()">
      <input id="propriedade" placeholder="NOME DA COL√îNIA" required oninput="this.value=this.value.toUpperCase()">
      <input id="endereco" placeholder="ENDERE√áO" oninput="this.value=this.value.toUpperCase()">
      <input id="telefone" placeholder="TELEFONE" type="number">
      <input id="apelido" placeholder="APELIDO" oninput="this.value=this.value.toUpperCase()">
      <input id="data" type="date" required>

      <!-- ‚úÖ CAIXINHA (voltou) -->
      <div class="check-row">
        <label>
          <input id="aberto" type="checkbox" />
          ABERTO NO SISDAF?
        </label>
        <small>Marque quando o cadastro j√° tiver sido aberto no sistema.</small>
      </div>

      <textarea id="obs" placeholder="OBSERVA√á√ïES" oninput="this.value=this.value.toUpperCase()"></textarea>
      <button class="btn btn-primary full" type="submit">üíæ SALVAR</button>
    </form>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>Produtor</th>
          <th>Propriedade</th>
          <th>Endere√ßo</th>
          <th>Telefone</th>
          <th>Data</th>
          <th>Aberto SISDAF</th>
          <th>Observa√ß√µes</th>
          <th>Apelido</th>
          <th>Prazo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="pager">
      <div class="left">
        <button id="prevBtn" class="mini" onclick="paginaAnterior()">‚óÄ Anterior</button>
        <button id="nextBtn" class="mini" onclick="proximaPagina()">Pr√≥xima ‚ñ∂</button>
        <span class="info" id="pageInfo">P√°gina 1</span>
      </div>

      <div class="right">
        <span class="info">Itens por p√°gina:</span>
        <select id="pageSize">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <footer>¬© Todos os direitos reservados 2025</footer>
</div>

<script>
// üîê LOGIN LOCAL (robusto)
const usuarios = { RODRIGO:'maria', JANIEL:'1234', CASSIA:'1234', MARCOS:'1234', RAIMUNDA:'1234', ADMIN:'admin' };

function login(){
  const userEl = document.getElementById("loginUser");
  const passEl = document.getElementById("loginPass");

  const user = (userEl.value || "").trim().toUpperCase();
  const pass = (passEl.value || "").trim();

  if (!usuarios[user] || usuarios[user] !== pass) {
    alert("Login inv√°lido");
    return;
  }

  document.getElementById("loginModal").style.display = "none";
}

document.addEventListener("keydown", (e) => {
  const modal = document.getElementById("loginModal");
  if (e.key === "Enter" && modal && modal.style.display !== "none") {
    login();
  }
});

// üîë SUPABASE (N√ÉO MEXIDO)
const supabaseClient = window.supabase.createClient(
 "https://ykqfmgpppvafakcjiicy.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcWZtZ3BwcHZhZmFrY2ppaWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxOTY0OTEsImV4cCI6MjA4MTc3MjQ5MX0.6iU1kae3XJwJw6l-0Cd7bRarImHWhGbDMAVgUDwdmKo"
);

let editId = null;
let todos = [];
let currentPage = 1;

const pesquisaInput = document.getElementById("pesquisa");
const filtroStatus = document.getElementById("filtroStatus");
const pageSizeEl = document.getElementById("pageSize");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");

pesquisaInput.addEventListener("input", () => { currentPage = 1; renderTabela(); });
filtroStatus.addEventListener("change", () => { currentPage = 1; renderTabela(); });
pageSizeEl.addEventListener("change", () => { currentPage = 1; renderTabela(); });

function norm(v){ return String(v ?? "").toUpperCase().trim(); }

function diasRestantes(dataAbertura){
  const inicio = new Date(dataAbertura);
  const fim = new Date(inicio.getTime() + (60*24*60*60*1000));
  const agora = new Date();
  const diff = fim - agora;
  return Math.floor(diff / (1000*60*60*24));
}

function getStatus(c){
  const dias = diasRestantes(c.data_abertura);
  if (dias < 0) return "ENCERRADO";
  if (dias <= 10) return "ALERTA";
  return "EM_DIA";
}

function calcularPrazo(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return "<span class='chip chip-bad'>‚õî ENCERRADO</span>";
  if(dias <= 10) return `<span class='chip chip-warn'>‚ö†Ô∏è ${dias} dias</span>`;
  return `<span class='chip chip-ok'>‚úÖ ${dias} dias</span>`;
}

function classePrazo(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return "prazo-encerrado";
  if(dias <= 10) return "prazo-alerta";
  return "";
}

function filtrarLista(lista){
  const q = norm(pesquisaInput.value);
  const st = filtroStatus.value;

  return lista.filter(c => {
    if (st !== "TODOS" && getStatus(c) !== st) return false;
    if(!q) return true;

    const campos = [
      c.nome, c.propriedade, c.endereco, c.telefone,
      c.apelido, c.observacoes, c.data_abertura,
      (c.aberto_sisdaf ? "SIM" : "NAO")
    ].map(norm).join(" ");

    return campos.includes(q);
  });
}

function limparFiltros(){
  pesquisaInput.value = "";
  filtroStatus.value = "TODOS";
  pageSizeEl.value = "20";
  currentPage = 1;
  renderTabela();
}

function atualizarContadores(total, filtrado, exibido){
  document.getElementById("contador").textContent = total;
  document.getElementById("contadorFiltrado").textContent = filtrado;
  document.getElementById("contadorExibido").textContent = exibido;
}

function totalPaginas(totalItens){
  const size = Number(pageSizeEl.value);
  return Math.max(1, Math.ceil(totalItens / size));
}

function paginaAnterior(){
  if(currentPage > 1){
    currentPage--;
    renderTabela();
  }
}

function proximaPagina(){
  const filtrados = filtrarLista(todos);
  const tp = totalPaginas(filtrados.length);
  if(currentPage < tp){
    currentPage++;
    renderTabela();
  }
}

// üîÑ CARREGAR (Supabase igual)
async function carregar(){
  const { data } = await supabaseClient
    .from("cadastros_idaf")
    .select("*")
    .order("id");

  todos = data || [];
  renderTabela();
}

/* ‚úÖ Atualiza o checkbox direto na tabela */
async function atualizarAberto(id, checked){
  const { error } = await supabaseClient
    .from("cadastros_idaf")
    .update({ aberto_sisdaf: !!checked })
    .eq("id", id);

  if(error){
    alert("N√£o foi poss√≠vel atualizar a caixinha (verifique se existe a coluna 'aberto_sisdaf' no Supabase).");
    carregar();
  } else {
    // atualiza local sem precisar recarregar tudo
    const item = todos.find(x => x.id === id);
    if(item) item.aberto_sisdaf = !!checked;
  }
}

function renderTabela(){
  const listaEl = document.getElementById("lista");
  const filtrados = filtrarLista(todos);

  const size = Number(pageSizeEl.value);
  const tp = totalPaginas(filtrados.length);
  if(currentPage > tp) currentPage = tp;

  const start = (currentPage - 1) * size;
  const pageItems = filtrados.slice(start, start + size);

  atualizarContadores(todos.length, filtrados.length, pageItems.length);

  pageInfo.textContent = `P√°gina ${currentPage} de ${tp}`;
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= tp;

  listaEl.innerHTML = "";
  pageItems.forEach(c => {
    const checked = c.aberto_sisdaf ? "checked" : "";
    listaEl.innerHTML += `
      <tr class="${classePrazo(c.data_abertura)}">
        <td>${c.nome ?? ""}</td>
        <td>${c.propriedade ?? ""}</td>
        <td>${c.endereco ?? ""}</td>
        <td>${c.telefone ?? ""}</td>
        <td>${c.data_abertura ?? ""}</td>
        <td>
          <input type="checkbox" ${checked}
                 onchange="atualizarAberto(${c.id}, this.checked)">
        </td>
        <td>${c.observacoes ?? ""}</td>
        <td>${c.apelido ?? ""}</td>
        <td>${calcularPrazo(c.data_abertura)}</td>
        <td>
          <div class="actions-col">
            <button class="action-btn editar" onclick="editar(${c.id})">Editar</button>
            <button class="action-btn excluir" onclick="excluir(${c.id})">Excluir</button>
          </div>
        </td>
      </tr>
    `;
  });
}

// üíæ SALVAR (Supabase igual + campo do checkbox)
form.onsubmit = async e =>{
 e.preventDefault();
 const dados={
  propriedade:propriedade.value,
  nome:nome.value,
  endereco:endereco.value,
  telefone:telefone.value,
  data_abertura:data.value,
  observacoes:obs.value,
  apelido:apelido.value,
  aberto_sisdaf: !!document.getElementById("aberto").checked
 };
 editId
 ? await supabaseClient.from("cadastros_idaf").update(dados).eq("id",editId)
 : await supabaseClient.from("cadastros_idaf").insert([dados]);

 editId=null;
 form.reset();
 document.getElementById("aberto").checked = false;
 carregar();
};

// ‚úèÔ∏è EDITAR (Supabase igual + checkbox)
async function editar(id){
 const {data}=await supabaseClient.from("cadastros_idaf").select("*").eq("id",id).single();
 nome.value=data.nome;
 propriedade.value=data.propriedade;
 endereco.value=data.endereco;
 telefone.value=data.telefone;
 data.value=data.data_abertura;
 obs.value=data.observacoes;
 apelido.value=data.apelido;
 document.getElementById("aberto").checked = !!data.aberto_sisdaf;
 editId=id;
 window.scrollTo({ top: 0, behavior: "smooth" });
}

// ‚ùå EXCLUIR (Supabase igual)
async function excluir(id){
 if(confirm("Excluir registro?")){
  await supabaseClient.from("cadastros_idaf").delete().eq("id",id);
  carregar();
 }
}

// üìä EXCEL
function baixarExcel(){
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.table_to_sheet(document.querySelector("table"));
 XLSX.utils.book_append_sheet(wb,ws,"IDAF");
 XLSX.writeFile(wb,"cadastros_idaf.xlsx");
}

// üìÑ PDF (inclui a coluna "Aberto SISDAF")
function baixarPDF(){
  const registros = filtrarLista(todos);

  const pdf = new jspdf.jsPDF("landscape");
  pdf.setFontSize(14);
  pdf.text("Relat√≥rio IDAF", 14, 14);

  pdf.setFontSize(10);
  pdf.text(`Total de registros: ${registros.length}`, 14, 20);

  const head = [[
    "Produtor","Propriedade","Endere√ßo","Telefone","Data","Aberto SISDAF","Observa√ß√µes","Apelido","Prazo"
  ]];

  const body = registros.map(c => {
    const dias = diasRestantes(c.data_abertura);
    const prazo = (dias < 0) ? "ENCERRADO" : `${dias} dias`;
    const aberto = c.aberto_sisdaf ? "SIM" : "N√ÉO";

    return [
      c.nome || "",
      c.propriedade || "",
      c.endereco || "",
      c.telefone || "",
      c.data_abertura || "",
      aberto,
      c.observacoes || "",
      c.apelido || "",
      prazo
    ];
  });

  pdf.autoTable({
    head,
    body,
    startY: 24,
    styles: { fontSize: 8, cellPadding: 2, overflow: "linebreak", valign: "top" },
    headStyles: { fillColor: [40,120,180], textColor: 255, fontSize: 9 },
    columnStyles: {
      0:{cellWidth:30}, 1:{cellWidth:30}, 2:{cellWidth:32}, 3:{cellWidth:22},
      4:{cellWidth:18}, 5:{cellWidth:20}, 6:{cellWidth:62}, 7:{cellWidth:22}, 8:{cellWidth:16}
    },
    margin: { left: 10, right: 10 }
  });

  pdf.save("cadastros_idaf.pdf");
}

carregar();
</script>

</body>
</html>
