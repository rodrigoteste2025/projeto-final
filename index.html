<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro IDAF</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- EXCEL / PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --text:#0f172a;
  --muted:#64748b;
  --border:#d7dde7;
  --border2:#e6ebf2;
  --shadow:0 10px 26px rgba(2,6,23,.08);

  --primary:#2563eb;
  --primary2:#1d4ed8;

  --danger:#dc2626;
  --dangerSoft:#fee2e2;

  --ok:#16a34a;
  --okSoft:#dcfce7;

  --warn:#f59e0b;
  --warnSoft:#ffedd5;

  --radius:16px;
  --radiusSm:12px;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  color:var(--text);
  background: linear-gradient(180deg, #f7f9ff, #eef2ff);
  padding:16px;

  /* ‚úÖ evita rolagem horizontal */
  overflow-x: hidden;
}

.container{
  max-width: 1400px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}

h2{ margin:0; font-size:20px; }

.card{
  background: rgba(255,255,255,.95);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

.cardHeader{
  padding:12px 14px;
  border-bottom:1px solid var(--border2);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  background:#fbfdff;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border2);
  background:#fff;
  font-size:12px;
  color:var(--muted);
}

.controls{
  display:grid;
  grid-template-columns: 1fr 240px 240px 220px auto auto;
  gap:10px;
  padding:12px 14px;
}

.field{ position:relative; }
.field .icon{
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  opacity:.6;
  font-size:14px;
}
.field input{
  width:100%;
  padding:10px 12px 10px 32px;
  border-radius: var(--radiusSm);
  border:1px solid var(--border);
  background:#fff;
  outline:none;
}

select{
  width:100%;
  padding:10px 12px;
  border-radius: var(--radiusSm);
  border:1px solid var(--border);
  background:#fff;
  outline:none;
}

.btn{
  border:none;
  cursor:pointer;
  border-radius: var(--radiusSm);
  padding:10px 12px;
  font-weight:700;
  transition:.15s ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  user-select:none;
  white-space:nowrap;
}
.btn:active{ transform: translateY(1px); }

.btnPrimary{ background: linear-gradient(135deg, var(--primary), var(--primary2)); color:#fff; }
.btnGhost{ background:#fff; border:1px solid var(--border2); color:var(--text); }
.btnDark{ background:#0f172a; color:#fff; }

.notice{
  padding:12px 14px;
  border-radius: var(--radius);
  border:1px solid rgba(245,158,11,.28);
  background: rgba(255,237,213,.85);
  color:#9a3412;
}

/* Form */
.form{
  padding:12px 14px 14px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
.input, textarea{
  width:100%;
  padding:10px 12px;
  border-radius: var(--radiusSm);
  border:1px solid var(--border);
  outline:none;
  background:#fff;
}
textarea{
  grid-column: span 3;
  min-height: 42px;
  resize: vertical;
}
.form .full{ grid-column: span 3; }

/* ‚úÖ TABELA (sem rolagem horizontal) */
.tableWrap{
  overflow: hidden;
  background:#fff;
}

/* ‚úÖ grade (linhas e colunas) bem vis√≠vel */
table{
  width: 100%;
  border-collapse: collapse; /* üî• importante para as linhas ficarem certinhas */
  table-layout: fixed;       /* cabe na tela */
}

thead th{
  background:#0f172a;
  color:#fff;
  padding:10px 8px;
  font-size:11px;
  text-transform: uppercase;
  letter-spacing: .05em;

  border: 1px solid rgba(255,255,255,.18); /* linha no cabe√ßalho */
}

tbody td{
  padding:10px 8px;
  font-size:12px;
  vertical-align: top;
  background:#fff;

  /* ‚úÖ linhas vis√≠veis */
  border: 1px solid #cfd7e6;

  /* ‚úÖ quebra de linha e nada de corte */
  white-space: normal;
  overflow: hidden;
  text-overflow: clip;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.3;
}

tbody tr:hover td{
  background: #f6f9ff;
}

.prazo-alerta td{ background: rgba(245,158,11,.10) !important; }
.prazo-encerrado td{ background: rgba(220,38,38,.10) !important; }

/* ‚úÖ Larguras em % (cabem sem barra) */
th:nth-child(1), td:nth-child(1){ width: 12%; } /* produtor */
th:nth-child(2), td:nth-child(2){ width: 10%; } /* propriedade */
th:nth-child(3), td:nth-child(3){ width: 12%; } /* endere√ßo */
th:nth-child(4), td:nth-child(4){ width: 8%; }  /* telefone */
th:nth-child(5), td:nth-child(5){ width: 8%; }  /* data */
th:nth-child(6), td:nth-child(6){ width: 26%; } /* observa√ß√µes */
th:nth-child(7), td:nth-child(7){ width: 8%; text-align:center; vertical-align:middle; } /* aberta */
th:nth-child(8), td:nth-child(8){ width: 9%; text-align:center; vertical-align:middle; } /* prazo */
th:nth-child(9), td:nth-child(9){ width: 11%; } /* a√ß√µes */

/* ‚úÖ evita ENCERRADO sobrepor A√ß√µes */
td:nth-child(8){
  overflow: hidden !important;
}
td:nth-child(8) .chip{
  max-width: 100% !important;
  white-space: normal !important; /* permite quebrar */
  text-align:center;
}

/* Chips */
.chip{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:5px 8px;
  border-radius:999px;
  font-weight:800;
  font-size:11px;
  border:1px solid transparent;
}
.chipOk{ background: var(--okSoft); color: var(--ok); border-color: rgba(22,163,74,.22); }
.chipWarn{ background: var(--warnSoft); color: #b45309; border-color: rgba(245,158,11,.25); }
.chipBad{ background: var(--dangerSoft); color: var(--danger); border-color: rgba(220,38,38,.22); }

.checkCell input{
  width:18px;
  height:18px;
  cursor:pointer;
}

/* A√ß√µes */
.actions{
  display:flex;
  gap:6px;
  flex-direction:column;
  align-items: stretch;
}
.actionBtn{
  border:1px solid rgba(226,232,240,.9);
  background:#fff;
  border-radius: 10px;
  padding:7px 8px;
  font-weight:800;
  cursor:pointer;
  font-size:12px;
  transition:.15s ease;
}
.actionBtn:hover{ transform: translateY(-1px); }
.editBtn{ background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.22); color: var(--primary2); }
.delBtn{ background: rgba(220,38,38,.08); border-color: rgba(220,38,38,.20); color: var(--danger); }

/* Footer */
.footerBar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  padding:10px 14px;
  border-top:1px solid var(--border2);
  background:#fbfdff;
}
.footerBar small{ color: var(--muted); }

/* LOGIN */
#loginModal{
  position:fixed;
  inset:0;
  background: rgba(2,6,23,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index: 2000;
}
#loginBox{
  width: 360px;
  background: rgba(255,255,255,.95);
  border:1px solid rgba(226,232,240,.9);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}
#loginBox h3{ margin:0 0 10px; font-size:16px; }
#loginBox input{
  width:100%;
  padding:10px 12px;
  border-radius: var(--radiusSm);
  border:1px solid var(--border);
  outline:none;
  margin-bottom:10px;
}
#loginBox button{ width:100%; }

/* LOADING */
#loadingOverlay{
  position:fixed;
  inset:0;
  background: rgba(255,255,255,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 1500;
}
.loadingBox{
  background:#fff;
  border:1px solid var(--border2);
  border-radius: var(--radius);
  padding:16px 18px;
  box-shadow: var(--shadow);
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
}
.spinner{
  width:18px;
  height:18px;
  border:3px solid #cbd5e1;
  border-top-color: var(--primary);
  border-radius:50%;
  animation: spin 1s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

/* TOAST */
#toast{
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 3000;
  display:none;
  max-width: 340px;
}
.toastBox{
  background:#0f172a;
  color:#fff;
  padding:12px 14px;
  border-radius: 14px;
  box-shadow: var(--shadow);
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.toastBox small{ color: rgba(255,255,255,.75); display:block; margin-top:2px; }
.toastIcon{
  width:26px;
  height:26px;
  border-radius: 9px;
  background: rgba(22,163,74,.18);
  display:flex;
  align-items:center;
  justify-content:center;
}

/* MODAL CONFIRMA√á√ÉO */
#confirmModal{
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index: 2500;
}
.confirmBox{
  width: 420px;
  max-width: 100%;
  background:#fff;
  border:1px solid var(--border2);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.confirmHead{
  padding:12px 14px;
  background:#fbfdff;
  border-bottom:1px solid var(--border2);
  font-weight:900;
}
.confirmBody{
  padding:14px;
  color: var(--text);
}
.confirmBody p{ margin: 0; color: var(--muted); }
.confirmFooter{
  padding:12px 14px;
  border-top:1px solid var(--border2);
  display:flex;
  justify-content:flex-end;
  gap:10px;
}
.btnDanger{
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  color:#fff;
}

/* Responsive */
@media (max-width: 1100px){
  .controls{ grid-template-columns: 1fr 1fr; }
}
@media (max-width: 900px){
  .form{ grid-template-columns: 1fr 1fr; }
  textarea, .form .full{ grid-column: span 2; }

  tbody td{ font-size: 11px; padding: 8px 6px; }
  thead th{ font-size: 10px; padding: 9px 6px; }
}
@media (max-width: 650px){
  body{ padding:12px; }
  .controls{ grid-template-columns: 1fr; }
  .form{ grid-template-columns: 1fr; }
  textarea, .form .full{ grid-column: span 1; }
  .btn{ width:100%; }
}
</style>
</head>

<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="loadingBox">
    <div class="spinner"></div>
    <div>Carregando‚Ä¶</div>
  </div>
</div>

<!-- TOAST -->
<div id="toast">
  <div class="toastBox">
    <div class="toastIcon">‚úÖ</div>
    <div>
      <b id="toastTitle">Salvo com sucesso</b>
      <small id="toastMsg">Altera√ß√£o registrada.</small>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal">
  <div class="confirmBox">
    <div class="confirmHead">Confirmar exclus√£o</div>
    <div class="confirmBody">
      <b>Deseja excluir este registro?</b>
      <p>Essa a√ß√£o n√£o pode ser desfeita.</p>
    </div>
    <div class="confirmFooter">
      <button class="btn btnGhost" onclick="closeConfirm()">Cancelar</button>
      <button class="btn btnDanger" id="confirmOkBtn">Excluir</button>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginModal">
  <div id="loginBox">
    <h3>Login</h3>
    <input id="loginUser" placeholder="USU√ÅRIO" oninput="this.value=this.value.toUpperCase()">
    <input id="loginPass" type="password" placeholder="SENHA">
    <button class="btn btnPrimary" onclick="login()">Entrar</button>
  </div>
</div>

<div class="container">

  <div class="card">
    <div class="cardHeader">
      <div>
        <h2>Cadastros IDAF</h2>
        <div class="badge">
          <span><b id="contador">0</b> total</span> ‚Ä¢
          <span><b id="contadorFiltrado">0</b> filtrados</span> ‚Ä¢
          <span><b id="contadorExibido">0</b> na p√°gina</span>
        </div>
      </div>
      <div class="badge" id="pageInfo">P√°gina 1</div>
    </div>

    <div class="controls">
      <div class="field">
        <span class="icon">üîé</span>
        <input id="pesquisa" placeholder="Pesquisar..." />
      </div>

      <select id="filtroStatus">
        <option value="TODOS">Status: Todos</option>
        <option value="EM_DIA">Status: Em dia</option>
        <option value="ALERTA">Status: Alerta (‚â§10 dias)</option>
        <option value="ENCERRADO">Status: Encerrado</option>
      </select>

      <select id="filtroAberta">
        <option value="TODOS">Aberta no sistema: Todos</option>
        <option value="SIM">Aberta no sistema: Sim</option>
        <option value="NAO">Aberta no sistema: N√£o</option>
      </select>

      <select id="pageSize">
        <option value="10">10 / p√°gina</option>
        <option value="20" selected>20 / p√°gina</option>
        <option value="30">30 / p√°gina</option>
        <option value="50">50 / p√°gina</option>
      </select>

      <button class="btn btnGhost" onclick="limparFiltros()">Limpar</button>
      <button class="btn btnDark" onclick="baixarExcel()">üìä Excel</button>
    </div>

    <div class="footerBar">
      <div>
        <button id="prevBtn" class="btn btnGhost" onclick="paginaAnterior()">‚óÄ Anterior</button>
        <button id="nextBtn" class="btn btnGhost" onclick="proximaPagina()">Pr√≥xima ‚ñ∂</button>
      </div>
      <div>
        <button class="btn btnDark" onclick="baixarPDF()">üìÑ PDF</button>
      </div>
    </div>
  </div>

  <div class="notice">‚ö†Ô∏è Aviso: o prazo inicial √© de 30 dias, com possibilidade de prorroga√ß√£o por mais 30 dias!</div>

  <div class="card">
    <div class="cardHeader">
      <span class="badge">üìù Cadastro</span>
      <span class="badge" id="editBadge">Novo registro</span>
    </div>

    <form id="form" class="form">
      <input class="input" id="nome" placeholder="PRODUTOR" required oninput="this.value=this.value.toUpperCase()">
      <input class="input" id="propriedade" placeholder="PROPRIEDADE" required oninput="this.value=this.value.toUpperCase()">
      <input class="input" id="endereco" placeholder="ENDERE√áO" oninput="this.value=this.value.toUpperCase()">
      <input class="input" id="telefone" placeholder="TELEFONE">
      <input class="input" id="data" type="date" required>
      <textarea id="obs" placeholder="OBSERVA√á√ïES" oninput="this.value=this.value.toUpperCase()"></textarea>
      <button class="btn btnPrimary full" type="submit">üíæ Salvar</button>
    </form>
  </div>

  <div class="card">
    <div class="cardHeader">
      <span class="badge">üìã Registros</span>
      <span class="badge">Clique no checkbox para marcar SIM/N√ÉO</span>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Produtor</th>
            <th>Propriedade</th>
            <th>Endere√ßo</th>
            <th>Telefone</th>
            <th>Data</th>
            <th>Observa√ß√µes</th>
            <th>Aberta no sistema</th>
            <th>Prazo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

    <div class="footerBar">
      <small>¬© 2025 ‚Ä¢ Sistema de Cadastros</small>
      <small>Dica: use filtros e pesquisa no topo</small>
    </div>
  </div>

</div>

<script>
// üîê LOGIN LOCAL
const usuarios = { RODRIGO:'maria', JANIEL:'1234', CASSIA:'1234', MARCOS:'1234', RAIMUNDA:'1234', ADMIN:'admin' };
function login(){
  const user = (document.getElementById("loginUser").value || "").trim().toUpperCase();
  const pass = (document.getElementById("loginPass").value || "").trim();
  if (!usuarios[user] || usuarios[user] !== pass) return alert("Login inv√°lido");
  document.getElementById("loginModal").style.display="none";
}

// üîë SUPABASE (N√ÉO MEXIDO)
const supabaseClient = window.supabase.createClient(
 "https://ykqfmgpppvafakcjiicy.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcWZtZ3BwcHZhZmFrY2ppaWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxOTY0OTEsImV4cCI6MjA4MTc3MjQ5MX0.6iU1kae3XJwJw6l-0Cd7bRarImHWhGbDMAVgUDwdmKo"
);

let editId = null;
let todos = [];
let currentPage = 1;

const pesquisaInput = document.getElementById("pesquisa");
const filtroStatus = document.getElementById("filtroStatus");
const filtroAberta = document.getElementById("filtroAberta");
const pageSizeEl = document.getElementById("pageSize");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");
const editBadge = document.getElementById("editBadge");

const loadingOverlay = document.getElementById("loadingOverlay");
const toast = document.getElementById("toast");
const toastTitle = document.getElementById("toastTitle");
const toastMsg = document.getElementById("toastMsg");

const confirmModal = document.getElementById("confirmModal");
const confirmOkBtn = document.getElementById("confirmOkBtn");

pesquisaInput.addEventListener("input", () => { currentPage = 1; renderTabela(); });
filtroStatus.addEventListener("change", () => { currentPage = 1; renderTabela(); });
filtroAberta.addEventListener("change", () => { currentPage = 1; renderTabela(); });
pageSizeEl.addEventListener("change", () => { currentPage = 1; renderTabela(); });

function showLoading(on){ loadingOverlay.style.display = on ? "flex" : "none"; }

let toastTimer = null;
function showToast(title, msg){
  toastTitle.textContent = title || "Salvo com sucesso";
  toastMsg.textContent = msg || "Altera√ß√£o registrada.";
  toast.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { toast.style.display = "none"; }, 2200);
}

function norm(v){ return String(v ?? "").toUpperCase().trim(); }

function diasRestantes(dataAbertura){
  const inicio = new Date(dataAbertura);
  const fim = new Date(inicio.getTime() + (60*24*60*60*1000));
  const agora = new Date();
  const diff = fim - agora;
  return Math.floor(diff / (1000*60*60*24));
}

function calcularPrazoChip(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return `<span class="chip chipBad">‚õî ENCERRADO</span>`;
  if(dias <= 10) return `<span class="chip chipWarn">‚ö†Ô∏è ${dias} dias</span>`;
  return `<span class="chip chipOk">‚úÖ ${dias} dias</span>`;
}

function classePrazo(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return "prazo-encerrado";
  if(dias <= 10) return "prazo-alerta";
  return "";
}

function getStatus(c){
  const dias = diasRestantes(c.data_abertura);
  if (dias < 0) return "ENCERRADO";
  if (dias <= 10) return "ALERTA";
  return "EM_DIA";
}

function filtrarLista(lista){
  const q = norm(pesquisaInput.value);
  const st = filtroStatus.value;
  const ab = filtroAberta.value;

  return lista.filter(c => {
    if (st !== "TODOS" && getStatus(c) !== st) return false;

    if (ab !== "TODOS"){
      const isSim = !!c.aberta_no_sistema;
      if (ab === "SIM" && !isSim) return false;
      if (ab === "NAO" && isSim) return false;
    }

    if(!q) return true;

    const campos = [
      c.nome, c.propriedade, c.endereco, c.telefone,
      c.observacoes, c.data_abertura,
      c.aberta_no_sistema ? "SIM" : "NAO"
    ].map(norm).join(" ");

    return campos.includes(q);
  });
}

function limparFiltros(){
  pesquisaInput.value = "";
  filtroStatus.value = "TODOS";
  filtroAberta.value = "TODOS";
  pageSizeEl.value = "20";
  currentPage = 1;
  renderTabela();
}

function atualizarContadores(total, filtrado, exibido){
  document.getElementById("contador").textContent = total;
  document.getElementById("contadorFiltrado").textContent = filtrado;
  document.getElementById("contadorExibido").textContent = exibido;
}

function totalPaginas(totalItens){
  const size = Number(pageSizeEl.value);
  return Math.max(1, Math.ceil(totalItens / size));
}

function paginaAnterior(){ if(currentPage > 1){ currentPage--; renderTabela(); } }
function proximaPagina(){
  const filtrados = filtrarLista(todos);
  const tp = totalPaginas(filtrados.length);
  if(currentPage < tp){ currentPage++; renderTabela(); }
}

async function toggleAberta(id, valor){
  showLoading(true);
  const { error } = await supabaseClient
    .from("cadastros_idaf")
    .update({ aberta_no_sistema: valor })
    .eq("id", id);
  showLoading(false);

  if(error){
    alert("Erro ao salvar: " + error.message);
    await carregar();
    return;
  }

  const item = todos.find(x => x.id === id);
  if(item) item.aberta_no_sistema = valor;

  showToast("Salvo com sucesso", valor ? "Marcado como SIM." : "Marcado como N√ÉO.");
}

async function carregar(){
  showLoading(true);
  const { data, error } = await supabaseClient
    .from("cadastros_idaf")
    .select("*")
    .order("id");
  showLoading(false);

  if(error){
    alert("Erro ao carregar: " + error.message);
    return;
  }

  todos = data || [];
  renderTabela();
}

function renderTabela(){
  const listaEl = document.getElementById("lista");
  const filtrados = filtrarLista(todos);

  const size = Number(pageSizeEl.value);
  const tp = totalPaginas(filtrados.length);
  if(currentPage > tp) currentPage = tp;

  const start = (currentPage - 1) * size;
  const pageItems = filtrados.slice(start, start + size);

  atualizarContadores(todos.length, filtrados.length, pageItems.length);

  pageInfo.textContent = `P√°gina ${currentPage} de ${tp}`;
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= tp;

  listaEl.innerHTML = "";
  pageItems.forEach(c => {
    listaEl.innerHTML += `
      <tr class="${classePrazo(c.data_abertura)}">
        <td>${c.nome ?? ""}</td>
        <td>${c.propriedade ?? ""}</td>
        <td>${c.endereco ?? ""}</td>
        <td>${c.telefone ?? ""}</td>
        <td>${c.data_abertura ?? ""}</td>
        <td>${c.observacoes ?? ""}</td>

        <td class="checkCell">
          <input type="checkbox" ${c.aberta_no_sistema ? "checked" : ""}
            onchange="toggleAberta(${c.id}, this.checked)">
        </td>

        <td>${calcularPrazoChip(c.data_abertura)}</td>

        <td>
          <div class="actions">
            <button class="actionBtn editBtn" onclick="editar(${c.id})">Editar</button>
            <button class="actionBtn delBtn" onclick="confirmarExcluir(${c.id})">Excluir</button>
          </div>
        </td>
      </tr>
    `;
  });
}

form.onsubmit = async e =>{
 e.preventDefault();
 const dados={
  propriedade:propriedade.value,
  nome:nome.value,
  endereco:endereco.value,
  telefone:telefone.value,
  data_abertura:data.value,
  observacoes:obs.value
 };

 showLoading(true);
 const resp = editId
   ? await supabaseClient.from("cadastros_idaf").update(dados).eq("id",editId)
   : await supabaseClient.from("cadastros_idaf").insert([dados]);
 showLoading(false);

 if(resp.error){
  alert("Erro ao salvar: " + resp.error.message);
  return;
 }

 editId=null;
 editBadge.textContent = "Novo registro";
 form.reset();
 showToast("Salvo com sucesso", "Registro salvo.");
 carregar();
};

async function editar(id){
 showLoading(true);
 const {data, error}=await supabaseClient.from("cadastros_idaf").select("*").eq("id",id).single();
 showLoading(false);

 if(error){
  alert("Erro ao carregar registro: " + error.message);
  return;
 }

 nome.value=data.nome;
 propriedade.value=data.propriedade;
 endereco.value=data.endereco;
 telefone.value=data.telefone;
 document.getElementById("data").value=data.data_abertura;
 obs.value=data.observacoes;
 editId=id;
 editBadge.textContent = `Editando ID: ${id}`;
 window.scrollTo({ top: 0, behavior: "smooth" });
}

/* modal excluir */
let pendingDeleteId = null;
function confirmarExcluir(id){
  pendingDeleteId = id;
  confirmModal.style.display = "flex";
  confirmOkBtn.onclick = async () => { await excluirConfirmado(); };
}
function closeConfirm(){
  confirmModal.style.display = "none";
  pendingDeleteId = null;
}
async function excluirConfirmado(){
  if(!pendingDeleteId) return;
  closeConfirm();
  showLoading(true);
  const { error } = await supabaseClient.from("cadastros_idaf").delete().eq("id",pendingDeleteId);
  showLoading(false);

  if(error){
    alert("Erro ao excluir: " + error.message);
    return;
  }
  showToast("Exclu√≠do", "Registro removido com sucesso.");
  carregar();
}

function baixarExcel(){
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.table_to_sheet(document.querySelector("table"));
 XLSX.utils.book_append_sheet(wb,ws,"IDAF");
 XLSX.writeFile(wb,"cadastros_idaf.xlsx");
}

function baixarPDF(){
  const registros = filtrarLista(todos);

  const pdf = new jspdf.jsPDF("landscape");
  pdf.setFontSize(14);
  pdf.text("Relat√≥rio IDAF", 14, 14);

  const head = [[
    "Produtor","Propriedade","Endere√ßo","Telefone","Data","Observa√ß√µes","Aberta no sistema","Prazo"
  ]];

  const body = registros.map(c => {
    const dias = diasRestantes(c.data_abertura);
    const prazo = (dias < 0) ? "ENCERRADO" : `${dias} dias`;

    return [
      c.nome || "",
      c.propriedade || "",
      c.endereco || "",
      c.telefone || "",
      c.data_abertura || "",
      c.observacoes || "",
      c.aberta_no_sistema ? "SIM" : "N√ÉO",
      prazo
    ];
  });

  pdf.autoTable({
    head,
    body,
    startY: 20,
    styles: { fontSize: 8, cellPadding: 2, overflow: "linebreak", valign: "top" },
    headStyles: { fillColor: [15, 23, 42], textColor: 255, fontSize: 9 },
    columnStyles: { 5:{cellWidth:100} },
    margin: { left: 10, right: 10 }
  });

  pdf.save("cadastros_idaf.pdf");
}

carregar();
</script>

</body>
</html>
