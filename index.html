<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro IDAF</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- EXCEL / PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#f3f4f6;
  --surface:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#d1d5db;
  --border2:#e5e7eb;

  --primary:#1f6fb2;
  --primary-dark:#185a8d;

  --danger:#b91c1c;
  --danger-soft:#ffe6e6;

  --warning:#b45309;
  --warning-soft:#fff3cd;

  --ok:#166534;
  --ok-soft:#e8f7ee;

  --shadow: 0 8px 22px rgba(0,0,0,.08);
  --radius: 12px;
  --radius-sm: 10px;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:16px;
  font-family: Arial, Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* container */
.container{
  max-width:1200px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* topbar */
.topbar{
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
  position: sticky;
  top: 10px;
  z-index: 10;
}

.topbar-row{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.title h2{
  margin:0;
  font-size: 18px;
}
.title p{
  margin:6px 0 0;
  font-size: 13px;
  color: var(--muted);
}

/* controls */
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.search{
  flex: 1;
  min-width: 240px;
  position: relative;
}

.search .icon{
  position:absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  opacity:.55;
  font-size: 14px;
}

.search input{
  width:100%;
  padding: 10px 12px 10px 36px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: #fff;
  font-size: 14px;
  outline:none;
}

.search input:focus{
  border-color: rgba(31,111,178,.55);
  box-shadow: 0 0 0 3px rgba(31,111,178,.12);
}

select{
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: #fff;
  font-size: 14px;
  outline:none;
}
select:focus{
  border-color: rgba(31,111,178,.55);
  box-shadow: 0 0 0 3px rgba(31,111,178,.12);
}

/* buttons */
button, .btn{
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: #f9fafb;
  font-size: 14px;
  cursor:pointer;
  transition: .15s ease;
}

button:hover, .btn:hover{
  background: #f3f4f6;
}

.btn-primary{
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
  font-weight: bold;
}
.btn-primary:hover{
  background: var(--primary-dark);
  border-color: var(--primary-dark);
}

.btn-neutral{
  background: #374151;
  border-color: #374151;
  color:#fff;
  font-weight: bold;
}
.btn-neutral:hover{
  background: #1f2937;
  border-color: #1f2937;
}

.btn-outline{
  background: #fff;
}

/* notices */
.notice, .aviso-fixo{
  background: var(--warning-soft);
  border: 1px solid #f3d08a;
  color: var(--warning);
  padding: 12px 14px;
  border-radius: var(--radius);
  box-shadow: 0 6px 16px rgba(0,0,0,.06);
}

/* card */
.card{
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* form */
form{
  padding:14px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}

input, textarea{
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  font-size: 14px;
  outline:none;
  background: #fff;
}

input:focus, textarea:focus{
  border-color: rgba(31,111,178,.55);
  box-shadow: 0 0 0 3px rgba(31,111,178,.12);
}

textarea{
  grid-column: span 3;
  resize: vertical;
  min-height: 42px;
}

form .full{
  grid-column: span 3;
}

/* table */
.table-wrap{ overflow-x:auto; }

table{
  width:100%;
  border-collapse: separate;
  border-spacing: 0;
}

thead th{
  background: #0f2f4a;
  color: #fff;
  padding: 10px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: .04em;
  border-bottom: 1px solid rgba(255,255,255,.15);
}

tbody td{
  padding: 10px;
  border-bottom: 1px solid var(--border2);
  font-size: 13px;
  vertical-align: top;
  overflow-wrap:anywhere;
}

tbody tr:nth-child(even){ background:#fafafa; }
tbody tr:hover{ background:#eef6ff; }

/* prazo destaque por linha */
.prazo-alerta{ background: rgba(245,158,11,.10) !important; }
.prazo-encerrado{ background: rgba(220,38,38,.08) !important; }

/* chips */
.chip{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 5px 10px;
  border-radius: 999px;
  font-weight: bold;
  font-size: 12px;
  border: 1px solid var(--border);
  background: #f3f4f6;
  white-space: nowrap;
}

.chip-ok{ background: var(--ok-soft); border-color: rgba(22,101,52,.25); color: var(--ok); }
.chip-warn{ background: var(--warning-soft); border-color: rgba(180,83,9,.25); color: var(--warning); }
.chip-bad{ background: var(--danger-soft); border-color: rgba(185,28,28,.25); color: var(--danger); }

/* actions */
.actions-col{
  display:flex;
  flex-direction: column;
  gap:6px;
}

.action-btn{
  width:100%;
  padding: 8px 10px;
  border-radius: 10px;
  border:1px solid var(--border);
  font-size: 13px;
  font-weight: bold;
}

.editar{
  background: #eaf2ff;
  border-color: rgba(31,111,178,.25);
  color: #1f6fb2;
}
.editar:hover{ background:#dfeaff; }

.excluir{
  background: #ffecec;
  border-color: rgba(185,28,28,.25);
  color: #b91c1c;
}
.excluir:hover{ background:#ffdede; }

/* pagination */
.pager{
  padding: 12px 14px;
  border-top: 1px solid var(--border2);
  background: #f9fafb;
  display:flex;
  justify-content: space-between;
  gap:10px;
  flex-wrap: wrap;
  align-items:center;
}

.pager .left, .pager .right{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.pager .info{
  font-size: 13px;
  color: var(--muted);
}

.pager .mini{
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background:#fff;
}
.pager .mini:disabled{
  opacity:.55;
  cursor:not-allowed;
}

/* login */
#loginModal{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 20px;
  z-index: 50;
}

#loginBox{
  width: 320px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}
#loginBox h3{
  margin: 0 0 10px;
  font-size: 16px;
}
#loginBox input{
  width:100%;
  margin-bottom: 10px;
}

/* footer */
footer{
  text-align:center;
  color: var(--muted);
  font-size: 12px;
  margin-top: 10px;
}

/* responsive */
@media (max-width: 900px){
  form{ grid-template-columns: 1fr 1fr; }
  textarea, form .full{ grid-column: span 2; }
}

@media (max-width: 650px){
  body{ padding:12px; }
  .controls{ flex-direction: column; align-items: stretch; }
  .search{ min-width: 100%; }
  button, select{ width:100%; }
  form{ grid-template-columns: 1fr; }
  textarea, form .full{ grid-column: span 1; }
}

</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginModal">
  <div id="loginBox">
    <h3>Login</h3>
    <p class="hint">Acesso restrito</p>
    <input id="loginUser" placeholder="USU√ÅRIO" oninput="this.value=this.value.toUpperCase()">
    <input id="loginPass" type="password" placeholder="SENHA">
    <button class="btn btn-primary" onclick="login()">Entrar</button>
  </div>
</div>

<div class="container">
  <div class="topbar">
    <div class="topbar-row">
      <div class="title">
        <h2>Acompanhar os Cadastros de Explora√ß√µes Agropecu√°rias</h2>
        <p>
          <span id="contador">0</span> registro(s) ‚Ä¢
          <span id="contadorFiltrado">0</span> ap√≥s filtro ‚Ä¢
          <span id="contadorExibido">0</span nesta p√°gina
        </p>
      </div>

      <div class="controls">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="pesquisa" placeholder="Pesquisar por produtor, col√¥nia, endere√ßo, telefone, apelido, observa√ß√µes..." />
        </div>

        <select id="filtroStatus" title="Filtro por status">
          <option value="TODOS">Status: Todos</option>
          <option value="EM_DIA">Status: Em dia</option>
          <option value="ALERTA">Status: Alerta (‚â§10 dias)</option>
          <option value="ENCERRADO">Status: Encerrado</option>
        </select>

        <button class="btn btn-outline" onclick="limparFiltros()">Limpar</button>
        <button class="btn btn-neutral" onclick="baixarExcel()">üìä Excel</button>
        <button class="btn btn-neutral" onclick="baixarPDF()">üìÑ PDF</button>
      </div>
    </div>
  </div>

  <div class="notice">‚ö†Ô∏è Aviso: o prazo inicial √© de 30 dias, com possibilidade de prorroga√ß√£o por mais 30 dias!</div>
  <div class="notice">‚ö†Ô∏è Aviso: depois da abertura do cadastro no SISDAF, clicar em excluir!</div>

  <div class="card">
    <form id="form">
      <input id="nome" placeholder="PROPRIET√ÅRIO" required oninput="this.value=this.value.toUpperCase()">
      <input id="propriedade" placeholder="NOME DA COL√îNIA" required oninput="this.value=this.value.toUpperCase()">
      <input id="endereco" placeholder="ENDERE√áO" oninput="this.value=this.value.toUpperCase()">
      <input id="telefone" placeholder="TELEFONE" type="number">
      <input id="apelido" placeholder="APELIDO" oninput="this.value=this.value.toUpperCase()">
      <input id="data" type="date" required>
      <textarea id="obs" placeholder="OBSERVA√á√ïES" oninput="this.value=this.value.toUpperCase()"></textarea>
      <button class="btn btn-primary full" type="submit">üíæ SALVAR</button>
    </form>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>Produtor</th>
          <th>Propriedade</th>
          <th>Endere√ßo</th>
          <th>Telefone</th>
          <th>Data</th>
          <th>Observa√ß√µes</th>
          <th>Apelido</th>
          <th>Prazo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="pager">
      <div class="left">
        <button id="prevBtn" class="mini" onclick="paginaAnterior()">‚óÄ Anterior</button>
        <button id="nextBtn" class="mini" onclick="proximaPagina()">Pr√≥xima ‚ñ∂</button>
        <span class="info" id="pageInfo">P√°gina 1</span>
      </div>

      <div class="right">
        <span class="info">Itens por p√°gina:</span>
        <select id="pageSize">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <footer>¬© Todos os direitos reservados 2025</footer>
</div>

<script>
// üîê LOGIN LOCAL (robusto)
const usuarios = { RODRIGO:'maria', JANIEL:'1234', CASSIA:'1234', MARCOS:'1234', RAIMUNDA:'1234', ADMIN:'admin' };

function login(){
  const userEl = document.getElementById("loginUser");
  const passEl = document.getElementById("loginPass");

  const user = (userEl.value || "").trim().toUpperCase();
  const pass = (passEl.value || "").trim();

  if (!usuarios[user] || usuarios[user] !== pass) {
    alert("Login inv√°lido");
    return;
  }

  document.getElementById("loginModal").style.display = "none";
}

document.addEventListener("keydown", (e) => {
  const modal = document.getElementById("loginModal");
  if (e.key === "Enter" && modal && modal.style.display !== "none") {
    login();
  }
});

// üîë SUPABASE (N√ÉO MEXIDO)
const supabaseClient = window.supabase.createClient(
 "https://ykqfmgpppvafakcjiicy.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcWZtZ3BwcHZhZmFrY2ppaWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxOTY0OTEsImV4cCI6MjA4MTc3MjQ5MX0.6iU1kae3XJwJw6l-0Cd7bRarImHWhGbDMAVgUDwdmKo"
);

let editId = null;
let todos = [];
let currentPage = 1;

const pesquisaInput = document.getElementById("pesquisa");
const filtroStatus = document.getElementById("filtroStatus");
const pageSizeEl = document.getElementById("pageSize");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");

pesquisaInput.addEventListener("input", () => { currentPage = 1; renderTabela(); });
filtroStatus.addEventListener("change", () => { currentPage = 1; renderTabela(); });
pageSizeEl.addEventListener("change", () => { currentPage = 1; renderTabela(); });

function norm(v){ return String(v ?? "").toUpperCase().trim(); }

function diasRestantes(dataAbertura){
  const inicio = new Date(dataAbertura);
  const fim = new Date(inicio.getTime() + (60*24*60*60*1000));
  const agora = new Date();
  const diff = fim - agora;
  return Math.floor(diff / (1000*60*60*24));
}

function getStatus(c){
  const dias = diasRestantes(c.data_abertura);
  if (dias < 0) return "ENCERRADO";
  if (dias <= 10) return "ALERTA";
  return "EM_DIA";
}

function calcularPrazo(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return "<span class='chip chip-bad'>‚õî ENCERRADO</span>";
  if(dias <= 10) return `<span class='chip chip-warn'>‚ö†Ô∏è ${dias} dias</span>`;
  return `<span class='chip chip-ok'>‚úÖ ${dias} dias</span>`;
}

function classePrazo(dataAbertura){
  const dias = diasRestantes(dataAbertura);
  if(dias < 0) return "prazo-encerrado";
  if(dias <= 10) return "prazo-alerta";
  return "";
}

function filtrarLista(lista){
  const q = norm(pesquisaInput.value);
  const st = filtroStatus.value;

  return lista.filter(c => {
    if (st !== "TODOS" && getStatus(c) !== st) return false;
    if(!q) return true;

    const campos = [
      c.nome, c.propriedade, c.endereco, c.telefone,
      c.apelido, c.observacoes, c.data_abertura
    ].map(norm).join(" ");

    return campos.includes(q);
  });
}

function limparFiltros(){
  pesquisaInput.value = "";
  filtroStatus.value = "TODOS";
  pageSizeEl.value = "20";
  currentPage = 1;
  renderTabela();
}

function atualizarContadores(total, filtrado, exibido){
  document.getElementById("contador").textContent = total;
  document.getElementById("contadorFiltrado").textContent = filtrado;
  document.getElementById("contadorExibido").textContent = exibido;
}

function totalPaginas(totalItens){
  const size = Number(pageSizeEl.value);
  return Math.max(1, Math.ceil(totalItens / size));
}

function paginaAnterior(){
  if(currentPage > 1){
    currentPage--;
    renderTabela();
  }
}

function proximaPagina(){
  const filtrados = filtrarLista(todos);
  const tp = totalPaginas(filtrados.length);
  if(currentPage < tp){
    currentPage++;
    renderTabela();
  }
}

// üîÑ CARREGAR (Supabase igual)
async function carregar(){
  const { data } = await supabaseClient
    .from("cadastros_idaf")
    .select("*")
    .order("id");

  todos = data || [];
  renderTabela();
}

function renderTabela(){
  const listaEl = document.getElementById("lista");
  const filtrados = filtrarLista(todos);

  const size = Number(pageSizeEl.value);
  const tp = totalPaginas(filtrados.length);
  if(currentPage > tp) currentPage = tp;

  const start = (currentPage - 1) * size;
  const pageItems = filtrados.slice(start, start + size);

  atualizarContadores(todos.length, filtrados.length, pageItems.length);

  pageInfo.textContent = `P√°gina ${currentPage} de ${tp}`;
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= tp;

  listaEl.innerHTML = "";
  pageItems.forEach(c => {
    listaEl.innerHTML += `
      <tr class="${classePrazo(c.data_abertura)}">
        <td>${c.nome ?? ""}</td>
        <td>${c.propriedade ?? ""}</td>
        <td>${c.endereco ?? ""}</td>
        <td>${c.telefone ?? ""}</td>
        <td>${c.data_abertura ?? ""}</td>
        <td>${c.observacoes ?? ""}</td>
        <td>${c.apelido ?? ""}</td>
        <td>${calcularPrazo(c.data_abertura)}</td>
        <td>
          <div class="actions-col">
            <button class="action-btn editar" onclick="editar(${c.id})">Editar</button>
            <button class="action-btn excluir" onclick="excluir(${c.id})">Excluir</button>
          </div>
        </td>
      </tr>
    `;
  });
}

// üíæ SALVAR (Supabase igual)
form.onsubmit = async e =>{
 e.preventDefault();
 const dados={
  propriedade:propriedade.value,
  nome:nome.value,
  endereco:endereco.value,
  telefone:telefone.value,
  data_abertura:data.value,
  observacoes:obs.value,
  apelido:apelido.value,
 };
 editId
 ? await supabaseClient.from("cadastros_idaf").update(dados).eq("id",editId)
 : await supabaseClient.from("cadastros_idaf").insert([dados]);

 editId=null;
 form.reset();
 carregar();
};

// ‚úèÔ∏è EDITAR (Supabase igual)
async function editar(id){
 const {data}=await supabaseClient.from("cadastros_idaf").select("*").eq("id",id).single();
 nome.value=data.nome;
 propriedade.value=data.propriedade;
 endereco.value=data.endereco;
 telefone.value=data.telefone;
 data.value=data.data_abertura;
 obs.value=data.observacoes;
 apelido.value=data.apelido;
 editId=id;
 window.scrollTo({ top: 0, behavior: "smooth" });
}

// ‚ùå EXCLUIR (Supabase igual)
async function excluir(id){
 if(confirm("Excluir registro?")){
  await supabaseClient.from("cadastros_idaf").delete().eq("id",id);
  carregar();
 }
}

// üìä EXCEL
function baixarExcel(){
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.table_to_sheet(document.querySelector("table"));
 XLSX.utils.book_append_sheet(wb,ws,"IDAF");
 XLSX.writeFile(wb,"cadastros_idaf.xlsx");
}

// üìÑ PDF (corrigido: n√£o l√™ html da tabela)
function baixarPDF(){
  const registros = filtrarLista(todos);

  const pdf = new jspdf.jsPDF("landscape");
  pdf.setFontSize(14);
  pdf.text("Relat√≥rio IDAF", 14, 14);

  pdf.setFontSize(10);
  pdf.text(`Total de registros: ${registros.length}`, 14, 20);

  const head = [[
    "Produtor","Propriedade","Endere√ßo","Telefone","Data","Observa√ß√µes","Apelido","Prazo"
  ]];

  const body = registros.map(c => {
    const dias = diasRestantes(c.data_abertura);
    const prazo = (dias < 0) ? "ENCERRADO" : `${dias} dias`;

    return [
      c.nome || "",
      c.propriedade || "",
      c.endereco || "",
      c.telefone || "",
      c.data_abertura || "",
      c.observacoes || "",
      c.apelido || "",
      prazo
    ];
  });

  pdf.autoTable({
    head,
    body,
    startY: 24,
    styles: { fontSize: 8, cellPadding: 2, overflow: "linebreak", valign: "top" },
    headStyles: { fillColor: [40,120,180], textColor: 255, fontSize: 9 },
    columnStyles: {
      0:{cellWidth:34}, 1:{cellWidth:34}, 2:{cellWidth:36}, 3:{cellWidth:22},
      4:{cellWidth:20}, 5:{cellWidth:70}, 6:{cellWidth:26}, 7:{cellWidth:18}
    },
    margin: { left: 10, right: 10 }
  });

  pdf.save("cadastros_idaf.pdf");
}

carregar();
</script>

</body>
</html>
